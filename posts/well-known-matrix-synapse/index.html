<!doctype html><html><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/bulma@0.9.4/css/bulma.min.css><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css><link rel=stylesheet href=/css/style.css><link rel=stylesheet href=/css/syntax.css><meta name=viewport content="width=device-width,initial-scale=1"><title>beau</title><body><div id=content><div class="column is-two-thirds-desktop is-full-tablet is-full-mobile is-family-monospace"><div class="tile is-ancestor"><div class="tile is-parent"><article class="tile is-child notification is-primary"><div class=has-text-centered><div class="is-profile-image mb-5"><figure class="image is-128x128 is-inline-block"><a href=/><img class=is-profile-image src=/images/profile.jpeg alt="avatar of my cat chilling"></a></figure></div></div><p class=title>Beau</p><p class=subtitle>Systems Engineer</p><div class="content has-text-black"><p>internet of beau.</p></div><div id=icons class=has-text-centered><p><span class=icon-text><span class=icon><a href=https://github.com/beauso title="beauso Github"><i class="fa fa-github"></i></a></span>
<span></span></span>
<span class=icon-text><span class=icon><a href=mailto:ðŸ§ @beau.so><i class="fa fa-envelope"></i></a></span>
<span></span></span></p></article></div><div id=content></div><div class="tile is-parent is-8"><article class="tile is-child is-content box"><a href=/>../</a><p class=title>Allowing Matrix (synapse) federation without exposing 8448 via /.well-known/ delegation and nginx</p><p class=subtitle>June 14, 2022</p><div class=is-post-content><p><h2 id=problem>problem</h2><p>I have a matrix server called <code>example.com</code>, but it&rsquo;s actually hosted on <code>matrix.example.com</code>. I want to keep the cosmetic name of <code>example.com</code> and have all federation traffic route through 443 instead of 8488.</p><h2 id=what-is-delegation>what is delegation?</h2><p>Delegation is just a fancy term in the Matrix world for having a Matrix server name of <code>example.com</code> while having the actual endpoint other servers connect to being different, for example:</p><ul><li><code>different.example.com:443</code></li></ul><p>There are two main reasons why this is useful:</p><ul><li>Most people want their <em>second-level domain</em> as the cosmetic server name for their homeserver, e.g. <code>@beau:example.com</code>, even though the server itself is actually hosted on <code>matrix.example.com</code>.</li><li>Most people running a homeserver will expose other services via a reverse-proxy and therefore will already have 443 open. Opening another port in this case is unnecessary. By default, Matrix will look to federate on port 8448 with other servers, so we need to fix this by using the <code>/.well-known/</code> method.</li><li>You want to hide your public IP and proxy traffic to your homeserver via Cloudflare so need to listen on 443.</li></ul><h2 id=wtf-is-well-known-if-i-dont-know-what-it-is>wtf is well-known if I don&rsquo;t know what it is?</h2><p><em>&ldquo;well-known&rdquo;</em> locations are paths outlined in <a href=https://www.rfc-editor.org/rfc/rfc8615>RFC 8615</a>. They are &lsquo;reserved&rsquo; conventional locations that services can query to find information, if present:</p><ul><li><p>ACME (Automatic Certificate Management Environment) challenges to verify ownership of a domain via HTTP. Simply a check to see if a file at <code>http://&lt;YOUR_DOMAIN>/.well-known/acme-challenge/&lt;TOKEN>.</code> contains the correct token to prove ownership of a domain before requests can be made to the CA to obtain a TLS cert.</p></li><li><p>Service discovery: before making a request (e.g: on what hostname and port should I make this request?)</p></li><li><p>App relations - <a href=https://developers.google.com/digital-asset-links/v1/getting-started>digital asset links</a> allow websites to open content in associated applications rather than the web browser.</p></li></ul><p>In this case (service discovery), for federation between Matrix homeservers; it allows the requesting server to find on what location:port federation should take place. This is outlined in the <a href=https://spec.matrix.org/v1.2/server-server-api/>server-server</a> API specification.</p><h2 id=delegating-to-443-on-your-actual-matrix-server-instead-of-8488-on-the-second-level-domain>delegating to 443 on your actual matrix server instead of 8488 on the second-level domain</h2><h3 id=1-verify-failure-on-8488>1. verify failure on 8488</h3><p>By default, Matrix servers will check your server name, resolve the A/AAAA record to an IP address and make an HTTPS request to that IP on port 8488.</p><p>You can use the <a href=https://federationtester.matrix.org>matrix federation tester</a> and you&rsquo;ll probably get a result like:</p><p><code>Get "https://103.31.4.5:8448/_matrix/key/v2/server": context deadline exceeded (Client.Timeout exceeded while awaiting headers)</code></p><h3 id=2-make-a-json-file-on-your-web-server-containing-the-endpoint-of-your-actual-matrix-server-on-443>2. make a JSON file on your web server containing the endpoint of your actual matrix server on 443</h3><p>This is the key/value Matrix homeserver will inspect. I&rsquo;m using <a href=https://hub.docker.com/r/linuxserver/swag>SWAG</a>, so I&rsquo;ve created this file under the root directory <code>/config/www/synapse/delegation</code>:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-json data-lang=json><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nt>&#34;m.server&#34;</span><span class=p>:</span> <span class=s2>&#34;matrix.example.com:443&#34;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><h3 id=3-add-nginx-location-block-to-serve-the-above-json-from-the-well-known-uri>3. add nginx location block to serve the above JSON from the .well-known/ URI</h3><p>The Matrix delegation <code>.well-known/</code> (remember, the RFC states that each is registered to a &lsquo;reserved&rsquo; conventional location) is at <code>.well-known/matrix/server</code>.</p><p>So, we&rsquo;ll create a location block in nginx to make this discoverable. You need to specify <code>default_type</code> if you did not append the file-type <code>.json</code> to your delegation JSON.</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-nginx data-lang=nginx><span class=line><span class=cl>    <span class=k>location</span> <span class=p>=</span> <span class=s>/.well-known/matrix/server</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=kn>alias</span> <span class=s>/config/www/synapse/delegation</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=kn>default_type</span> <span class=s>application/json</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>You should then (after restarting nginx), be able to reach this at <code>https://example.com/.well-known/matrix/server</code>.</p><h3 id=4-verify-federation-is-working-on-443-now>4. verify federation is working on 443 now</h3><p><img src=/images/well-known-matrix-synapse/federation-success.png alt="Federation Successful"></p><p>You should also see a note that the the test <em>found</em> the .well-known file :</p><blockquote><p><em>server name/.well-known result contains explicit port number: no SRV lookup done</em></p></blockquote><p>If you haven&rsquo;t yet proxied traffic through Cloudflare, feel free to do so and retry the federation tester.</p></p></article></div></div></div></div></div></div></div></body></html>